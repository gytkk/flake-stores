name: Update App Versions

on:
  push:
  schedule:
    - cron: "15 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30

      - name: Run app update scripts
        run: |
          chmod +x ./scripts/update-all.sh
          ./scripts/update-all.sh

      - name: Verify changed package builds
        run: |
          if [ -z "$(git status --short apps | head -n 1)" ]; then
            echo "No package changes after updates"
            exit 0
          fi

          for package_file in $(git status --short apps | awk '{print $2}'); do
            app_name="$(echo "$package_file" | cut -d/ -f2)"
            nix build .#packages.x86_64-linux."$app_name" --no-link
          done

      - name: Commit and push updates
        run: |
          git diff --quiet && exit 0

          CHANGED_APPS=$(git status --short apps | awk '{print $2}' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps
          git commit -m "feat(apps): update app versions (${CHANGED_APPS})"
          git push
